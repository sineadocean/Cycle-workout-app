<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Workout Planner</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0f172a">

<style>
:root{
  --bg:#0f172a;
  --card:#111827;
  --card2:#0b1220;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --accent:#2dd4bf;
  --line:#1f2937;

  --menstrual:#f9a8d4;
  --follicular:#86efac;
  --ovulation:#fde68a;
  --early:#93c5fd;
  --late:#d1d5db;
}

*{box-sizing:border-box;}
body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto;
  background:var(--bg);
  color:var(--text);
}

header{
  position:sticky;
  top:0;
  z-index:10;
  background:#0f172aee;
  backdrop-filter:blur(8px);
  padding:14px;
  border-bottom:1px solid var(--line);
}

h1{margin:0;font-size:20px;}
#todayInfo{margin-top:6px;font-size:13px;color:var(--muted);}

.controls{
  margin-top:10px;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
}

input,button{
  padding:10px;
  border-radius:10px;
  border:1px solid var(--line);
  background:var(--card);
  color:var(--text);
  font-size:14px;
}

button.primary{
  border-color:var(--accent);
  box-shadow:0 0 0 3px #2dd4bf22;
}

.wrap{max-width:900px;margin:0 auto;}
#calendar{padding:12px;}

.card{
  border-radius:16px;
  background:var(--card);
  border:1px solid var(--line);
  overflow:hidden;
  margin:12px 0;
}

.bar{height:6px;}
.inner{padding:14px;}

.today{
  border-color:#2dd4bf66;
  box-shadow:0 0 0 4px #2dd4bf22;
}

.toprow{
  display:flex;
  justify-content:space-between;
  gap:10px;
  align-items:flex-start;
}

.title{
  font-weight:800;
  font-size:14px;
  letter-spacing:.2px;
}

.sub{
  margin-top:4px;
  font-size:12px;
  color:var(--muted);
}

.sectionTitle{
  margin:12px 0 6px;
  font-size:12px;
  color:var(--muted);
  font-weight:700;
  letter-spacing:.2px;
  text-transform:uppercase;
}

.planBox{
  padding:12px;
  border-radius:12px;
  border:1px solid var(--line);
  background:rgba(11,18,32,.55);
}

.planLine{
  margin:6px 0;
  line-height:1.35;
}

.kv{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:10px;
}

.pill{
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background:var(--card2);
  font-size:12px;
  color:var(--text);
}

label.track{
  display:flex;
  gap:10px;
  align-items:center;
  margin:8px 0;
  padding:10px 10px;
  border-radius:12px;
  border:1px solid var(--line);
  background:rgba(11,18,32,.45);
}

input[type="checkbox"]{
  width:22px;height:22px;
  accent-color:var(--accent);
}

textarea{
  width:100%;
  border-radius:12px;
  padding:12px;
  background:#020617;
  border:1px solid var(--line);
  color:var(--text);
  margin-top:10px;
  min-height:64px;
}
</style>
</head>

<body>
<div class="wrap">
<header>
  <h1>Workout Planner</h1>
  <div id="todayInfo">Loading…</div>

  <div class="controls">
    <input type="date" id="startDate" />
    <button class="primary" onclick="generate()">Refresh</button>
    <button onclick="resetAll()">Reset</button>
  </div>
</header>

<div id="calendar"></div>
</div>

<script>
/** Phase setup (your Stardust-aligned lengths)
  Menstrual: 1–6
  Follicular: 7–9
  Ovulation: 10–14
  Early luteal: 15–21
  Late luteal: 22–28
*/
const phases = [
  {
    name:'Menstrual', start:1, end:6, color:'var(--menstrual)',
    allowed:['Pilates','Walk (flat)'],
    avoid:['Weights','Incline treadmill']
  },
  {
    name:'Follicular', start:7, end:9, color:'var(--follicular)',
    allowed:['Weights','Incline treadmill'],
    avoid:['Pilates']
  },
  {
    name:'Ovulation', start:10, end:14, color:'var(--ovulation)',
    allowed:['Weights','Incline treadmill','Pilates'],
    avoid:[]
  },
  {
    name:'Early luteal', start:15, end:21, color:'var(--early)',
    allowed:['Weights','Incline treadmill'],
    avoid:['Pilates']
  },
  {
    name:'Late luteal', start:22, end:28, color:'var(--late)',
    allowed:['Pilates','Incline treadmill'],
    avoid:['Weights']
  }
];

/** Weekly constraints
  Tue = ballet (fixed)
  Thu = home-only (fixed)
*/
const weekly = {
  0:'Flexible',
  1:'Flexible',
  2:'Ballet',
  3:'Flexible',
  4:'Home-only (late)',
  5:'Flexible',
  6:'Flexible'
};

const LS_DATE  = 'cycleStart_local_v4';
const LS_STATE = 'cycleState_v4';

/** Local YYYY-MM-DD (no UTC drift) */
function isoLocal(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

function parseLocalDate(yyyy_mm_dd){
  const [y,m,d] = yyyy_mm_dd.split('-').map(Number);
  return new Date(y, m-1, d);
}

function weekdayLabel(i){
  return ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][i];
}

function niceDateNoWeekday(d){
  // removes weekday to avoid duplication
  return d.toLocaleDateString(undefined, { year:'numeric', month:'short', day:'numeric' });
}

function getPhase(cycleDay){
  return phases.find(p => cycleDay >= p.start && cycleDay <= p.end) || phases[0];
}

function loadState(){
  try { return JSON.parse(localStorage.getItem(LS_STATE) || '{}') || {}; }
  catch { return {}; }
}
function saveState(s){ localStorage.setItem(LS_STATE, JSON.stringify(s)); }

/** Build gym + home recommendations (except Tue/Thu which are set) */
function getGymHomeRecs(phase){
  // gym rec
  let gym = [];
  let home = [];

  const weightsOK = phase.allowed.includes('Weights');
  const pilatesOK = phase.allowed.includes('Pilates');
  const inclineOK = phase.allowed.includes('Incline treadmill');
  const inclineAvoid = phase.avoid.includes('Incline treadmill');

  if (weightsOK){
    gym.push('Weights (strength session)');
    if (inclineOK) gym.push('Incline treadmill (short + steady, optional)');
    // home strength template
    home.push('At-home strength (bodyweight focus: lower + upper + core)');
  } else {
    // no weights phases
    if (pilatesOK) gym.push('Pilates (studio/gym space if you want)');
    if (inclineOK && !inclineAvoid) gym.push('Incline treadmill (steady, not HIIT)');
    if (!pilatesOK && inclineOK && !inclineAvoid) gym.push('Treadmill walk (easy)');
    if (!gym.length) gym.push('Gentle mobility / easy walk (no treadmill incline)');

    // home option mirrors
    if (pilatesOK) home.push('At-home Pilates');
    else home.push('Gentle mobility / stretching');
  }

  // ovulation can support either
  if (phase.name === 'Ovulation' && pilatesOK){
    // make home option nicer than just strength
    home = ['At-home strength OR Pilates (choose what feels best)'];
  }

  // menstrual: emphasize no incline treadmill
  if (phase.name === 'Menstrual'){
    gym = ['Pilates (gentle) OR rest'];
    home = ['At-home Pilates (gentle)'];
  }

  return { gym, home };
}

function generate(){
  const startVal = document.getElementById('startDate').value;
  if (!startVal){
    document.getElementById('todayInfo').textContent = 'Set your cycle start date once — I’ll remember it.';
    document.getElementById('calendar').innerHTML = '';
    return;
  }

  localStorage.setItem(LS_DATE, startVal);

  const startDate = parseLocalDate(startVal);
  const today = new Date();
  const todayKey = isoLocal(today);

  const state = loadState();
  const cal = document.getElementById('calendar');
  cal.innerHTML = '';

  let todayCycleDay = null;
  let todayPhaseName = null;

  for (let i=0; i<28; i++){
    const d = new Date(startDate);
    d.setDate(d.getDate() + i);

    const cycleDay = i + 1;
    const phase = getPhase(cycleDay);
    const key = isoLocal(d);

    if (key === todayKey){
      todayCycleDay = cycleDay;
      todayPhaseName = phase.name;
    }

    const constraint = weekly[d.getDay()];
    const recs = getGymHomeRecs(phase);

    const card = document.createElement('div');
    card.className = 'card';
    if (key === todayKey) card.classList.add('today');

    const bar = document.createElement('div');
    bar.className = 'bar';
    bar.style.background = phase.color;

    const inner = document.createElement('div');
    inner.className = 'inner';

    // header line (weekday only once)
    const top = document.createElement('div');
    top.className = 'toprow';
    top.innerHTML = `
      <div>
        <div class="title">Day ${cycleDay} — ${weekdayLabel(d.getDay())} • ${niceDateNoWeekday(d)}</div>
        <div class="sub">${phase.name}${constraint !== 'Flexible' ? ' • ' + constraint : ''}</div>
      </div>
    `;

    // plan content
    const planBox = document.createElement('div');
    planBox.className = 'planBox';

    if (constraint === 'Ballet'){
      planBox.innerHTML = `
        <div class="sectionTitle">Set plan</div>
        <div class="planLine">• Ballet class</div>
        <div class="kv">
          <span class="pill">Allowed: ${phase.allowed.join(', ')}</span>
          <span class="pill">Avoid: ${phase.avoid.length ? phase.avoid.join(', ') : '—'}</span>
        </div>
      `;
    } else if (constraint.startsWith('Home-only')){
      // Thursday fixed home plan
      const homeLine = phase.allowed.includes('Pilates')
        ? 'At-home Pilates'
        : (phase.allowed.includes('Weights') ? 'At-home strength (light bodyweight)' : 'Gentle mobility / stretching');
      planBox.innerHTML = `
        <div class="sectionTitle">Set plan</div>
        <div class="planLine">• ${homeLine}</div>
        <div class="kv">
          <span class="pill">Allowed: ${phase.allowed.join(', ')}</span>
          <span class="pill">Avoid: ${phase.avoid.length ? phase.avoid.join(', ') : '—'}</span>
        </div>
      `;
    } else {
      // all other days: show gym + home recommendations
      planBox.innerHTML = `
        <div class="sectionTitle">Gym recommendation</div>
        ${recs.gym.map(x=>`<div class="planLine">• ${x}</div>`).join('')}
        <div class="sectionTitle">Home recommendation</div>
        ${recs.home.map(x=>`<div class="planLine">• ${x}</div>`).join('')}
        <div class="kv">
          <span class="pill">Allowed: ${phase.allowed.join(', ')}</span>
          <span class="pill">Avoid: ${phase.avoid.length ? phase.avoid.join(', ') : '—'}</span>
        </div>
      `;
    }

    // tracking
    const trackTitle = document.createElement('div');
    trackTitle.className = 'sectionTitle';
    trackTitle.textContent = 'Track';

    const checksWrap = document.createElement('div');

    // Track items: ballet on Tue; home-only item on Thu; otherwise track first gym item + first home item
    let trackItems = [];
    if (constraint === 'Ballet'){
      trackItems = ['Ballet class'];
    } else if (constraint.startsWith('Home-only')){
      trackItems = phase.allowed.includes('Pilates') ? ['At-home Pilates'] :
                   (phase.allowed.includes('Weights') ? ['At-home strength (light bodyweight)'] : knownOr('Gentle mobility / stretching'));
    } else {
      // keep tracking simple and consistent
      const gymPrimary = recs.gym[0] || 'Gym session';
      const homePrimary = recs.home[0] || 'Home session';
      trackItems = [gymPrimary, homePrimary];
    }

    // helper for safety
    function knownOr(x){ return [x]; }

    trackItems.forEach(item=>{
      const id = `${key}__${item}`;
      const row = document.createElement('label');
      row.className = 'track';
      row.innerHTML = `<input type="checkbox" ${state[id] ? 'checked' : ''}><span>${item}</span>`;
      row.querySelector('input').onchange = (e)=>{
        state[id] = e.target.checked;
        saveState(state);
      };
      checksWrap.appendChild(row);
    });

    const note = document.createElement('textarea');
    note.placeholder = 'Notes (energy, mood, soreness, etc.)…';
    note.value = state[`${key}__note`] || '';
    note.oninput = (e)=>{
      state[`${key}__note`] = e.target.value;
      saveState(state);
    };

    inner.appendChild(top);
    inner.appendChild(planBox);
    inner.appendChild(trackTitle);
    inner.appendChild(checksWrap);
    inner.appendChild(note);

    card.appendChild(bar);
    card.appendChild(inner);
    cal.appendChild(card);
  }

  // header line
  const info = document.getElementById('todayInfo');
  if (todayCycleDay){
    info.textContent = `Today — ${niceDateNoWeekday(today)} • Cycle Day ${todayCycleDay} (${todayPhaseName})`;
  } else {
    info.textContent = `Today — ${niceDateNoWeekday(today)} (outside this 28-day view)`;
  }

  // scroll to today
  const todayEl = document.querySelector('.card.today');
  if (todayEl) {
    setTimeout(() => todayEl.scrollIntoView({behavior:'smooth', block:'start'}), 60);
  }
}

function resetAll(){
  localStorage.removeItem(LS_DATE);
  localStorage.removeItem(LS_STATE);
  location.reload();
}

window.onload = ()=>{
  const saved = localStorage.getItem(LS_DATE);
  if (saved){
    document.getElementById('startDate').value = saved;
    generate();
  } else {
    document.getElementById('todayInfo').textContent = 'Set your cycle start date once — I’ll remember it.';
  }
};
</script>
</body>
</html>
